package org.suntao.easyorm.xmlparse;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

/**
 * xml配置读取
 * <p>
 * 包含从xml文件中读取配置的各种方法
 * 
 * @author suntao
 * 
 */
public class XmlParse {
	/**
	 * 配置文件格式化
	 * <p>
	 * 将xml文件转化成easyorm配置实体<br>
	 * 方便读取和使用
	 * 
	 * @param xml
	 *            xml文件
	 * @return easyorm配置实体
	 */
	public static EasyormConfig configParse(File xml) {
		EasyormConfig result = new EasyormConfig();
		DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
		factory.setValidating(true);
		factory.setIgnoringElementContentWhitespace(true);
		try {
			DocumentBuilder builder = factory.newDocumentBuilder();
			Document xmlDoc = builder.parse(xml);
			result.setDbConfig(parseDataBaseConfig(xmlDoc));// 获取database实体
			result.setMappers(parseMappersConfig(xmlDoc));// 获取mapper实体
		} catch (ParserConfigurationException e) {
			e.printStackTrace();
		} catch (SAXException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return result;
	}

	/**
	 * 配置文件格式化
	 * <p>
	 * 将xml文件转化成easyorm配置实体<br>
	 * 方便读取和使用
	 * 
	 * @param xmlPath
	 *            文件位置
	 * @return easyorm配置实体
	 */
	public static EasyormConfig configParse(String xmlPath) {
		return configParse(new File(xmlPath));
	}

	/**
	 * 从Document 读取数据库配置
	 * <p>
	 * 读取数据库的url,驱动,driver,用户名和密码
	 * 
	 * @param doc
	 *            xml document
	 * @return DatabaseConfig 配置实体
	 */
	public static DatabaseConfig parseDataBaseConfig(Document doc) {
		DatabaseConfig result = null;
		Element dbElement = (Element) doc.getElementsByTagName("database")
				.item(0);
		if (dbElement != null) {
			NodeList children = dbElement.getChildNodes();
			result = new DatabaseConfig();
			for (int i = 0; i < children.getLength(); i++) {
				Element child = (Element) children.item(i);
				result.set(child.getNodeName(), child.getTextContent());
			}
		}
		return result;
	}

	/**
	 * 读取mappers
	 * <p>
	 * 从easyorm配置文件Document<br>
	 * 读取mapper文件的id和位置
	 * 
	 * @param doc
	 *            Document
	 * @return 存有mappers配置的arraylist
	 */
	public static ArrayList<MapperConfig> parseMappersConfig(Document doc) {
		ArrayList<MapperConfig> result = new ArrayList<MapperConfig>();
		NodeList mappersnode = doc.getElementsByTagName("mapper");
		for (int i = 0; i < mappersnode.getLength(); i++) {
			Element mapperElement = (Element) mappersnode.item(i);
			result.add(new MapperConfig(mapperElement.getAttribute("id"),
					mapperElement.getAttribute("location")));
		}
		return result;
	}
}
